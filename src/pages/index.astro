---
import site from '../data/site.json';
import '../styles/global.css';

const { meta, hero, sections, footer } = site;
const isExternal = (href: string = '') => /^https?:\/\//.test(href);
const iconPath = (name: string) => `/images/icons/${name}.svg`;
const gaMeasurementId = 'G-MT18WRFBGW';

const consentScript = `(() => {
  const GA_ID = ${JSON.stringify(gaMeasurementId)};
  const CONSENT_KEY = 'ga-consent';
  let bannerRef = null;
  const EU_REGIONS = ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE','GB','UK'];
  const EU_TIMEZONES = ['Europe/Amsterdam','Europe/Andorra','Europe/Athens','Europe/Belgrade','Europe/Berlin','Europe/Bratislava','Europe/Brussels','Europe/Bucharest','Europe/Budapest','Europe/Copenhagen','Europe/Dublin','Europe/Gibraltar','Europe/Helsinki','Europe/Kaliningrad','Europe/Lisbon','Europe/Ljubljana','Europe/London','Europe/Luxembourg','Europe/Madrid','Europe/Malta','Europe/Monaco','Europe/Oslo','Europe/Paris','Europe/Prague','Europe/Riga','Europe/Rome','Europe/San_Marino','Europe/Sarajevo','Europe/Skopje','Europe/Sofia','Europe/Stockholm','Europe/Tallinn','Europe/Tirane','Europe/Vaduz','Europe/Vatican','Europe/Vienna','Europe/Vilnius','Europe/Warsaw','Europe/Zagreb'];

  const readConsent = () => {
    try {
      return localStorage.getItem(CONSENT_KEY);
    } catch (error) {
      return null;
    }
  };

  const persistConsent = (value) => {
    try {
      localStorage.setItem(CONSENT_KEY, value);
    } catch (error) {
      // ignore storage errors
    }
  };

  const loadAnalytics = () => {
    if (!GA_ID || window.__gaLoaded) return;
    window.__gaLoaded = true;
    console.debug('[consent] loading analytics');
    const script = document.createElement('script');
    script.async = true;
    script.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
    document.head.appendChild(script);
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', GA_ID, { anonymize_ip: true });
  };

  const hideBanner = () => {
    if (bannerRef) bannerRef.hidden = true;
  };

  const applyChoice = (choice) => {
    if (choice === 'accept') {
      persistConsent('granted');
      loadAnalytics();
    } else {
      persistConsent('denied');
    }
    hideBanner();
  };

  const attachHandlers = () => {
    if (!bannerRef || bannerRef.dataset.handlers === 'true') return;
    bannerRef.dataset.handlers = 'true';
    const accept = bannerRef.querySelector('[data-consent="accept"]');
    const decline = bannerRef.querySelector('[data-consent="decline"]');
    accept?.addEventListener('click', () => {
      console.debug('[consent] accept clicked');
      applyChoice('accept');
    });
    decline?.addEventListener('click', () => {
      console.debug('[consent] decline clicked');
      applyChoice('decline');
    });
  };

  window.handleAnalyticsConsent = applyChoice;

  console.debug('[consent] script ready', {
    languages: navigator.languages,
    timeZone: (() => {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (error) {
        return 'unknown';
      }
    })(),
  });

  const isLikelyEU = () => {
    try {
      const languages = navigator.languages ?? [navigator.language];
      for (const lang of languages) {
        if (!lang) continue;
        const parts = lang.split('-');
        const region = parts[1]?.toUpperCase();
        if (region && EU_REGIONS.includes(region)) return true;
      }
    } catch (error) {}
    try {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (tz && EU_TIMEZONES.includes(tz)) return true;
    } catch (error) {}
    return false;
  };

  const initConsent = () => {
    bannerRef = document.getElementById('consentBanner');
    const consent = readConsent();

    if (consent === 'granted') {
      loadAnalytics();
      return;
    }
    if (consent === 'denied') return;

    if (!isLikelyEU()) {
      console.debug('[consent] non-EU locale detected, auto-granting');
      persistConsent('granted');
      loadAnalytics();
      return;
    }

    if (bannerRef) {
      bannerRef.hidden = false;
      attachHandlers();
    }
  };

  window.forceConsentBanner = () => {
    localStorage.removeItem(CONSENT_KEY);
    bannerRef = document.getElementById('consentBanner');
    if (!bannerRef) return;
    bannerRef.hidden = false;
    attachHandlers();
    console.debug('[consent] banner forced visible');
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initConsent, { once: true });
  } else {
    initConsent();
  }
})();`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{meta.title}</title>
    <meta name="description" content={meta.description} />
    <meta name="keywords" content={meta.keywords} />
    <meta name="author" content={meta.author} />
    <link rel="canonical" href={meta.url} />

    <meta property="og:title" content={meta.title} />
    <meta property="og:description" content={meta.description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={meta.url} />
    <meta property="og:image" content={meta.image} />
    <meta property="og:image:alt" content={`${meta.title} — personal link hub`} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={meta.title} />
    <meta name="twitter:description" content={meta.description} />
    <meta name="twitter:image" content={meta.image} />
    <meta name="theme-color" content="#0f7c66" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=3" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=3" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=3" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=3" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="shortcut icon" href="/favicon.ico?v=3" />
  </head>
  <body>
    <main>
      <section class="hero hero--simple" aria-labelledby="profile-title">
        <div class="hero__copy">
          {hero.eyebrow && <p class="hero__eyebrow">{hero.eyebrow}</p>}
          <h1 id="profile-title">{hero.name}</h1>
          {hero.subhead && <p class="hero__subhead">{hero.subhead}</p>}
        </div>
      </section>

      <section class="link-stack" aria-label="Personal link hub">
        {sections.map((section) => (
          <article class={`link-stack__section${section.accent ? ' link-stack__section--accent' : ''}`}>
            <header>
              <p class="card-code">{section.code}</p>
              <h2>{section.title}</h2>
              {section.note && <p class="card-note">{section.note}</p>}
            </header>
            <div class="link-pills">
              {section.links.map((link) => {
                const openInNewTab = link.newTab ?? isExternal(link.href);
                const relValue = openInNewTab ? 'noopener' : undefined;
                return (
                  <a
                    class="link-pill"
                    href={link.href}
                    target={openInNewTab ? '_blank' : undefined}
                    rel={relValue}
                  >
                    {link.icon && (
                      <span
                        class="link-pill__icon"
                        style={`--icon-image: url('${iconPath(link.icon)}'); --icon-color: ${link.brandColor ?? 'var(--accent)'};`}
                        aria-hidden="true"
                      />
                    )}
                    <div>
                      <span class="link-pill__label">{link.label}</span>
                      {link.meta && <span class="link-pill__meta">{link.meta}</span>}
                    </div>
                    <span class="link-pill__arrow" aria-hidden="true">↗</span>
                  </a>
                );
              })}
            </div>
          </article>
        ))}
      </section>

      <footer class="site-footer">
        <p>
          {footer.text}
          {footer.privacyHref && (
            <>
              {' '}
              <a href={footer.privacyHref}>{footer.privacyLabel ?? 'Privacy policy'}</a>
            </>
          )}
        </p>
      </footer>
    </main>
    <div id="consentBanner" class="consent-banner" hidden role="dialog" aria-live="polite" aria-label="Analytics consent">
      <p>We use cookies to measure engagement. Enable analytics?</p>
      <div class="consent-banner__actions">
        <button type="button" data-consent="accept">Allow analytics</button>
        <button type="button" class="secondary" data-consent="decline">No thanks</button>
      </div>
    </div>
    <script is:inline set:html={consentScript}></script>
  </body>
</html>
